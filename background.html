<!--

questions? -> dotkom@online.ntnu.no

~~~~feature list~~~~

general stuff:
[x] opens options page on first run
[x] faster updates and frequent clearing of localstorage in dev mode
[x] separate script containing constants for changeability
[x] fancy html5, css3 and jquery design on all pages
[x] all known errors and issues are handled
[x] runs google analytics on all pages
[x] injects google analytics on first time online

news feed:
[x] fetches and parse feed from Onlines website
[x] counts unread news and presents unread number in icon badge
[x] separates between new, updated and read items
[x] serves desktop notifications on news / updates
[x] fetch images asynchronously from the API and injects them only when needed

cantina dinners:
[x] fetches and parses feed from SiTs website, both from Hangaren and Realfag
[x] strips down dinner menu down to the bare necessities
[x] presents dinners with pricing in ascending order

light:
[x] reads light value from the arduino connected to draug.online.ntnu.no
[x] uses a stable border value, fairly unaffected by sunlight
[x] reads the light value frequently in order to react quickly to changes

calendar stuff:
[x] reads events from Onlines own server which again is parsed from GoogleCal
[x] uses very cheap, low latency requests for event information

icon stuff:
[x] changes icon based on light values and calendar events
[x] uses title text containing the name of the event, or other appropriate text
[x] separate icon showing when you're offline or when an error has occured

options page:
[x] option for showing office status in the icon
[x] option for desktop notifications
[x] option for fetching cantina dinner menu
[x] google +1 button for Onlines website
[x] fancy github link leading the way to the open repository
[x] all options react immediately to changes
[x] contains easter egg

content scritps for websites:
[x] detects when user is visiting the Online website, nullifying the counter badge
[x] notices when a user clicks a dinner menu, then opens sit.no and highlights the selected dinner

-->

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<script src="js/jquery-1.7.2.min.js"></script>
	<script src="js/constants.js"></script>
	<script src="js/parseFeed.js"></script>
	<script src="js/officeStatus.js"></script>
	<script src="js/cantinaMenu.js"></script>
	<script>
	
		// Stop the extension if localStorage is not supported
		if (typeof(localStorage)==='undefined') { // impossibru!!
			alert(EXTENSION_NAME + " Error: localStorage not supported");
			return;
		}
		
		// Dev mode? Clear localStorage
		if (DEBUG)
			localStorage.clear();
		
		// Set default choices and open options page after install
		if (localStorage.everConnected == undefined) {
			if (localStorage.showOfficeStatus == undefined)
				localStorage.showOfficeStatus = 'true';
			if (localStorage.showNotifications == undefined)
				localStorage.showNotifications = 'true';
			if (localStorage.showCantinaDinner == undefined)
				localStorage.showCantinaDinner = 'true';
			chrome.tabs.create({url: chrome.extension.getURL("options.html"), selected: true});
		}
		
		// Reset vars from last run
		cantinaMenu_reset();
		officeStatus_reset();
		localStorage.everConnected = 'false';
		localStorage.wasConnected = 'true';
		localStorage.mainLoopTimeout = MAIN_LOOP_QUICK_TIMEOUT;
		var iterationCounter = 1;
		
		// Setting the global timeout for all AJAX and JSON requests
		$.ajaxSetup({ timeout: REQUEST_TIMEOUT });
		
		function mainLoop() {
			if (DEBUG) console.log('\n# '+iterationCounter);
	
			// we're online :)
			if (navigator.onLine) {
				// now online, fetch all
				if (localStorage.wasConnected == 'false' || localStorage.everConnected == 'false') {
					officeStatus_update();
					fetchFeed(unreadCount);
					cantinaMenu_update();
				}
				if (localStorage.everConnected == 'false') {
					connectGoogleAnalytics();
				}
				// normal operation
				else {
					if (iterationCounter % REFRESH_OFFICE_INTERVAL == 0)
						officeStatus_update();
					if (iterationCounter % REFRESH_FEED_INTERVAL == 0)
						fetchFeed(unreadCount);
					if (iterationCounter % REFRESH_DINNER_INTERVAL == 0)
						cantinaMenu_update();
				}
				localStorage.everConnected = 'true';
				localStorage.wasConnected = 'true';
			}
			// we're offline :(
			else {
				officeStatus_disconnected(localStorage.wasConnected);
				localStorage.wasConnected = 'false';
			}
			
			iterationCounter++;
			if (10000 < iterationCounter) // no reason to count to infinity
				iterationCounter = 1;
			
			// Schedule for repetition once a minute (checking connectivity,
			// feed and office status). Runs every 3rd second if it's offline,
			// trying to react quickly upon reconnection...
			var loopTimeout = Number(localStorage.mainLoopTimeout);
			if (DEBUG || localStorage.wasConnected=='false')
				loopTimeout = MAIN_LOOP_QUICK_TIMEOUT;
			setTimeout(function() {
				mainLoop();
			}, loopTimeout);
		}
		
		// This page runs continously and will therefore experience downtime.
		// In case there is downtime when the page opens for the first time
		// we'll need to load the GAnalytics scripts once we're connected.
		function connectGoogleAnalytics() {
			if (DEBUG) console.log('connecting google analytics');
			var script = document.createElement("script");
			script.type = 'text/javascript';
			script.src = 'js/googleAnalytics.js';
			document.getElementsByTagName("head")[0].appendChild(script);
		}
		
		// Recieve all requests from parts of the extension that can't access
		// localStorage or the rest of the codebase. Example: A content script.
		function onRequest(request, sender, callback) {
			if (request.action == 'resetCounterWhenOnWebsite') {
				localStorage.unreadCount = 0;
				localStorage.mostRecentRead = localStorage.mostRecentUnread;
				chrome.browserAction.setBadgeText({text:''});
			}
			else if (request.action == 'getChosenDinner') {
				var chosenDinner = localStorage.chosenDinner;
				localStorage.removeItem("chosenDinner");
				callback(chosenDinner);
			}
			else if (DEBUG) console.log('ERROR: unrecognized request');
		}
		
		// wire up the onRequest listener function
		chrome.extension.onRequest.addListener(onRequest);

		// Document ready, go!
		$(function() {
			mainLoop();
		});

	</script>
	
</head>
<body>
</body>
</html>







