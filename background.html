<!--

questions? -> dotkom@online.ntnu.no

~~~~progression list~~~~

general stuff:
[x] open options page on first run
[x] reset vars in localStorage for when the extension is reloaded in dev-mode
[x] separate script containing constants for changeability
[x] run google analytics on all pages
[x] in background: inject google analytics on first time online

news feed stuff:
[x] fetch and parse feed from Onlines website
[x] count unread news and present number in a small badge
[x] separate between new, updated and read items
[x] serve desktop notifications on news / updates
[x] fancy desktop notification design
[x] popup presenting feed, separate between read and unread items
[x] fancy css3 design for popup
[x] fetch images asynchronously from the API and inject only when needed

cantina feed stuff:
[x] fetch and parse feed from SiTs website, both hangaren and realfag
[x] strip dinner menu down to the bare necessities
[x] present dinner in a fancy view in the popup

light stuff:
[x] read light value from the arduino connected to draug.online.ntnu.no
[x] find stable border value, fairly unaffected by sunlight
[x] read light value every 5 minutes

calendar stuff:
[x] read all this from Onlines own server to be able to handle more requests
[x] cheap requests, only asking for specifically needed info

icon stuff:
[x] change icon based on light values
[x] change icon based on calendar events
[x] use title text containing the name of the event
[x] separate icon showing when you're offline or when an error has occured

website stuff:
[x] detect when user is visiting the Online website
[x] fetch most recent news from Onlines website upon arrival
[x] nullify counter badge upon arrival

options stuff:
[x] option for showing office status in the icon
[x] option for desktop notifications
[x] option for fetching cantina dinner menu
[x] fancy css3 design for options page
[x] fancy checkboxes for options page (old ones hidden)
[x] google +1 button for Onlines website
[x] optimize the icons behaviour to react immediately to changes


~~~~remains before release~~~~

[ ] fikse bug med notification nÃ¥r man starter offline
[ ] v1.0


~~~~future stuff~~~~

[ ] update URL at Onlines servers
[ ] online notifier text in right-click menu should go somewhere
[ ] update to manifest v2 with new security policies
[ ] light info should be served through static_service

- random:
	for (foo in bar) console.log(foo + ' :: ' + bar[foo]);

-->

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<script src="js/jquery-1.7.2.min.js"></script>
	<script src="js/constants.js"></script>
	<script src="js/parseFeed.js"></script>
	<script src="js/officeStatus.js"></script>
	<script src="js/cantinaDinner.js"></script>
	<script>
	
		// Stop the extension if localStorage is not supported
		if (typeof(localStorage)==='undefined') { // impossibru!!
			alert(EXTENSION_NAME + " Error: localStorage not supported");
			return;
		}
		
		// Reset localStorage in dev mode, just reset office status otherwise
		if (DEBUG)
			localStorage.clear();
		else {
			officeStatus_reset(true, true);
			cantinaDinner_reset();
		}
		
		// Set some values and open options page after install
		if (localStorage.everConnected != 'true') {
			if (localStorage.showOfficeStatus == undefined)
				localStorage.showOfficeStatus = 'true';
			if (localStorage.showNotifications == undefined)
				localStorage.showNotifications = 'true';
			if (localStorage.showCantinaDinners == undefined)
				localStorage.showCantinaDinners = 'true';
			chrome.tabs.create({url: chrome.extension.getURL("options.html"), selected: true});
		}
		
		localStorage.everConnected = 'false';
		localStorage.wasConnected = 'true';
		var iterationCounter = 1;

		function mainLoop() {
			if (DEBUG) console.log('\n# '+iterationCounter);
	
			// we're online :)
			if (navigator.onLine) {
				// now online, fetch all
				if (localStorage.wasConnected == 'false' || localStorage.everConnected == 'false') {
					officeStatus_update();
					fetchFeed(unreadCount);
					cantinaDinner_update();
				}
				if (localStorage.everConnected == 'false') {
					connectGoogleAnalytics();
				}
				// normal operation
				else {
					if (iterationCounter % REFRESH_OFFICE_INTERVAL == 0)
						officeStatus_update();
					if (iterationCounter % REFRESH_FEED_INTERVAL == 0)
						fetchFeed(unreadCount);
					if (iterationCounter % REFRESH_DINNER_INTERVAL == 0)
						cantinaDinner_update();
				}
				localStorage.everConnected = 'true';
				localStorage.wasConnected = 'true';
			}
			// we're offline :(
			else {
				officeStatus_disconnected(localStorage.wasConnected);
				localStorage.wasConnected = 'false';
			}
			
			iterationCounter++;
			if (10000 < iterationCounter) // no reason to count to infinity
				iterationCounter = 1;
		}
		
		// This page runs continously and will therefore experience downtime.
		// In case there is downtime when the page opens for the first time
		// we'll need to load the GAnalytics scripts once we're connected.
		function connectGoogleAnalytics() {
			if (DEBUG) console.log('connecting google analytics');
			var script = document.createElement("script");
			script.type = 'text/javascript';
			script.src = 'js/googleAnalytics.js';
			document.getElementsByTagName("head")[0].appendChild(script);
		}
		
		// Recieve all requests from parts of the extension that can't access
		// localStorage or the rest of the codebase. Example: A content script.
		function onRequest(request, sender, callback) {
			if (request.action == 'resetCounterWhenOnWebsite') {
				localStorage.unreadCount = 0;
				localStorage.mostRecentRead = localStorage.mostRecentUnread;
				chrome.browserAction.setBadgeText({text:''});
			}
			else if (DEBUG) console.log('ERROR: unrecognized request');
		}
		
		// wire up the onRequest listener function
		chrome.extension.onRequest.addListener(onRequest);

		// Document ready, go!
		$(function() {
			// Execute once
			mainLoop();
			// Schedule for repetition once a minute (checking connectivity,
			// feed and office status). Runs every 3rd second in DEBUG-mode.
			setInterval(function() {
				mainLoop();
			}, (DEBUG ? 3000 : 60000));
		});

	</script>
	
</head>
<body>
</body>
</html>







